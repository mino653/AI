<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chatbot | Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
<style>
    /* CSS Variables for Modern Theming (KEEP THIS SECTION FOR THE NEW LOOK) */
    :root {
        /* Light Theme Defaults */
        --color-bg: #f0f2f5; /* Soft light background */
        --color-container-bg: #ffffff;
        --color-header-bg: #4a90e2; /* A modern blue */
        --color-text: #2c3e50; /* Dark navy text */
        --color-user-msg: #d9f7be; /* Soft user bubble */
        --color-bot-msg: #e9ecef; /* Neutral light gray bot bubble */
        --color-input-border: #cccccc;
        --color-code-bg: #f8f9fa; /* Very light code block */
        --color-code-text: #333333;
        --color-code-border: #e0e0e0;
        --color-copy-btn: #888888;
        --color-copy-btn-hover: #4a90e2;
        --color-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Dark Theme Overrides */
    .dark-mode {
        --color-bg: #121212; /* Deep dark background */
        --color-container-bg: #1e1e1e; /* Dark container */
        --color-header-bg: #1f3a5f; /* Darker blue */
        --color-text: #e0e0e0;
        --color-user-msg: #2d452d; /* Dark moss green user bubble */
        --color-bot-msg: #282828; /* Dark neutral bot bubble */
        --color-input-border: #444444;
        --color-code-bg: #1d1f21; /* Atom Dark theme code block */
        --color-code-text: #c5c8c6;
        --color-code-border: #444444;
        --color-copy-btn: #aaaaaa;
        --color-copy-btn-hover: #80bfff;
        --color-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    /* BASE STYLING */
    body { 
        font-family: 'Roboto', sans-serif;
        margin: 0; 
        padding: 20px; 
        background-color: var(--color-bg);
        display: flex;
        justify-content: center;
        transition: background-color 0.4s, color 0.4s;
        color: var(--color-text);
        height: 100vh;
    }
    #main-container {
        width: 100%;
        max-width: 900px; /* Slightly wider chat box */
        background-color: var(--color-container-bg);
        border-radius: 16px; /* Softer edges */
        box-shadow: var(--color-shadow);
        overflow: hidden;
        height: 100%; /* Fill the viewport space */
        display: flex;
        flex-direction: column;
    }
    #chat-header {
        background-color: var(--color-header-bg);
        color: white;
        padding: 16px 25px;
        font-size: 1.5em;
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .theme-toggle {
        cursor: pointer;
        font-size: 1.4em;
        transition: transform 0.2s;
        margin-right: 5px;
        user-select: none;
    }
    .theme-toggle:hover {
        transform: scale(1.1);
    }
    #chat-window { 
        flex-grow: 1;
        padding: 25px; 
        overflow-y: auto; 
        scroll-behavior: smooth;
    }
    #chat-input-area { 
        display: flex; 
        padding: 20px 25px; 
        border-top: 1px solid var(--color-input-border);
        background-color: var(--color-container-bg);
    }
    #user-input { 
        flex-grow: 1; 
        padding: 14px 22px; 
        border: 2px solid var(--color-input-border); 
        border-radius: 25px; 
        margin-right: 12px;
        font-size: 1.05em;
        background-color: var(--color-container-bg);
        color: var(--color-text);
        transition: border-color 0.3s;
    }
    #user-input:focus {
        outline: none;
        border-color: var(--color-header-bg); /* Highlight on focus */
    }
    #send-button { 
        padding: 12px 25px; 
        background-color: var(--color-header-bg); 
        color: white; 
        border: none; 
        cursor: pointer; 
        border-radius: 25px; 
        font-size: 1.05em;
        font-weight: 500;
        transition: background-color 0.2s, transform 0.1s;
    }
    #send-button:hover {
        background-color: #387ac9; /* Slightly darker blue on hover */
    }
    #send-button:active {
        transform: scale(0.98);
    }
    #send-button:disabled {
        background-color: #b0c4de;
        cursor: not-allowed;
    }

    /* MESSAGE BUBBLES */
    .msg-row {
        display: flex;
        margin-bottom: 25px; 
        align-items: flex-start;
    }
    .avatar {
        width: 40px; 
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: white;
        font-size: 1.1em;
        flex-shrink: 0;
        margin-top: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .user-avatar { background-color: #4CAF50; order: 2; margin-left: 12px; }
    .bot-avatar { background-color: var(--color-header-bg); order: 1; margin-right: 12px; }

    .msg-content {
        padding: 15px 20px;
        border-radius: 18px; /* More rounded corners */
        max-width: 75%; /* Slightly narrower message width */
        line-height: 1.7;
        word-wrap: break-word;
        text-align: left;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow on bubbles */
    }
    .user-row { justify-content: flex-end; }
    .user-row .msg-content { 
        background-color: var(--color-user-msg); 
        order: 1; 
        border-bottom-right-radius: 4px; /* Tail effect on user side */
    }
    .bot-row { justify-content: flex-start; }
    .bot-row .msg-content { 
        background-color: var(--color-bot-msg); 
        order: 2; 
        border-bottom-left-radius: 4px; /* Tail effect on bot side */
    }
    
    /* Ensure content formatting is clean inside messages */
    .msg-content p { margin-top: 0; margin-bottom: 1em; }
    .msg-content p:last-child { margin-bottom: 0; }

    /* Code block styling simplified for stability */
    .msg-content pre {
        background-color: var(--color-code-bg);
        color: var(--color-code-text);
        padding: 15px 20px;
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 0.9em;
        margin: 10px 0; /* Add margin around code block */
        white-space: pre-wrap; 
        word-break: break-all;
        overflow-x: auto;
        line-height: 1.4;
        border-radius: 6px;
        border: 1px solid var(--color-code-border);
    }
    
    /* TYPING INDICATOR STYLING */
    .loading-row .msg-content {
        background-color: #e6e6fa;
        color: #555;
        font-style: italic;
        padding-top: 15px;
        padding-bottom: 15px;
        animation: pulse 1.5s infinite;
    }
    .dark-mode .loading-row .msg-content {
         background-color: #444;
         color: #ccc;
    }
    @keyframes pulse {
        0% { opacity: 0.7; }
        50% { opacity: 1.0; }
        100% { opacity: 0.7; }
    }
</style>
</head>

<body>
    <div id="main-container">
        <header id="chat-header">
            <span>Gemini Chatbot</span>
            <span id="theme-toggle" class="material-symbols-rounded theme-toggle">
                light_mode
            </span>
        </header>

        <div id="chat-window">
            <div class="msg-row bot-row">
                <div class="avatar bot-avatar">AI</div>
                <div class="msg-content">
                    <p>Hello! I'm Test, an AI assistant powered by Gemini. Ask me anything about coding, deployment, or general knowledge!</p>
                </div>
            </div>
            </div>

        <div id="chat-input-area">
            <input type="text" id="user-input" placeholder="Ask me anything..." autocomplete="off">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/14.1.0/markdown-it.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // DOM Elements
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const themeToggle = document.getElementById('theme-toggle');

        // State Variables
        const md = new markdownit(); // Markdown parser
        let isWaitingForResponse = false;
        let conversationHistory = []; // Stores raw text for context

        // --- Core Functions ---

        /**
         * Adds a message to the chat window and scrolls to the bottom.
         * @param {string} sender - 'user' or 'bot'
         * @param {string} content - HTML content of the message.
         * @returns {HTMLElement} The message row element.
         */
        function addMessage(sender, content) {
            const row = document.createElement('div');
            row.className = `msg-row ${sender}-row`;
            row.innerHTML = `
                <div class="avatar ${sender}-avatar">${sender === 'user' ? 'You' : 'AI'}</div>
                <div class="msg-content">${content}</div>
            `;
            chatWindow.appendChild(row);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return row;
        }

        /**
         * Sends user message and requests a response from the Flask backend.
         */
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '' || isWaitingForResponse) return;

            // 1. Update State and UI
            isWaitingForResponse = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Wait...';

            // 2. Add User Message and Context
            // Render user input as simple HTML
            const userHtmlContent = `<p>${message}</p>`; 
            addMessage('user', userHtmlContent);
            
            // Add user message to history
            conversationHistory.push(message);
            // Combine history for context (backend uses this entire string)
            const fullContext = conversationHistory.join('\n\n---CONTEXT BREAK---\n\n');

            userInput.value = '';

            // 3. Add Loading Indicator
            const loadingRow = addMessage('bot', 'AI is thinking...');
            loadingRow.classList.add('loading-row');

            try {
                // 4. Send Request to Backend
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: fullContext })
                });

                // 5. Process Response
                const data = await response.json();
                let botResponse = data.response;

                // Remove loading indicator
                loadingRow.remove();

                if (response.ok) {
                    // Render Markdown content to HTML (stable, simple markdown parsing)
                    const renderedContent = md.render(botResponse); 
                    addMessage('bot', renderedContent);
                    
                    // Add the bot response to history (for next context)
                    conversationHistory.push(botResponse);

                } else {
                    // Handle server errors
                    const errorContent = `<p>Error: ${botResponse}</p>`;
                    addMessage('bot', errorContent);
                }

            } catch (error) {
                console.error('Fetch error:', error);
                loadingRow.remove();
                addMessage('bot', `<p>Connection Error: Could not reach the server.</p>`);
            } finally {
                // 6. Reset State and UI
                isWaitingForResponse = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        // --- Event Listeners ---

        // Send message on button click
        sendButton.addEventListener('click', sendMessage);

        // Send message on Enter key press
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line in input box
                sendMessage();
            }
        });

        // Theme Toggle Logic
        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            themeToggle.textContent = isDarkMode ? 'dark_mode' : 'light_mode';
        });

        // Load theme preference on initial load
        (function loadTheme() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'dark_mode';
            } else {
                themeToggle.textContent = 'light_mode';
            }
        })();
    </script>
</body>
</html>
